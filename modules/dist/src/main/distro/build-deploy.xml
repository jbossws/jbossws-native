<?xml version="1.0" encoding="UTF-8"?>

<!-- ====================================================================== -->
<!--                                                                        -->
<!--  JBoss, the OpenSource J2EE webOS                                      -->
<!--                                                                        -->
<!--  Distributable under LGPL license.                                     -->
<!--  See terms of license at http://www.gnu.org.                           -->
<!--                                                                        -->
<!-- ====================================================================== -->

<project>

  <!-- ================================================================== -->
  <!-- Prepare Deployment Structure JBoss-6.0.0                           -->
  <!-- ================================================================== -->

  <target name="deploy-structure-jboss600" depends="prepare-deploy">
    <delete dir="${deploy.structure}"/>
    <antcall target="deploy-jbossws-native" inheritall="false">
      <param name="installserver" value="${deploy.structure}/server/${jboss.server.instance}"/>
      <param name="jbossid" value="${jbossws.integration.target}"/>
      <param name="artifactsdir" value="${deploy.artifacts.dir}"/>
      <param name="thirdpartydir" value="${deploy.artifacts.dir}"/>
      <param name="modifyjbossintegration" value="true"/><!-- [JBWS-2505] -->
    </antcall>
    <macro-create-deploy-conf deploystructure="${deploy.structure}"/>
  </target>

  <!-- ================================================================== -->
  <!-- Deployment JBoss600                                                -->
  <!-- ================================================================== -->

  <target name="target-jboss600">
    <property name="jbossws.integration.target" value="jboss600"/>
    <echo message="jbossws.integration.target=${jbossws.integration.target}" file="${target.properties.file}"/>
  </target>

  <target name="deploy-jboss600" depends="undeploy-jboss600,deploy-structure-jboss600" description="Deploy jbossws to jboss600">
    <fail message="Not available: ${jboss600.available.file}" unless="jboss600.available"/>
    <copy todir="${jboss600.home}" overwrite="true" verbose="true">
      <fileset dir="${deploy.structure}"/>
    </copy>
    <chmod dir="${jboss600.home}/bin" perm="+x" includes="*.sh"/>
  </target>

  <target name="undeploy-jboss600" depends="target-jboss600,init" description="Remove jbossws from jboss600">
    <fail message="Not available: ${jboss600.available.file}" unless="jboss600.available"/>
    <macro-undeploy-jbossws targetdir="${jboss600.server}"
                            defaultconf="${jbossws.default.deploy.conf}"
                            defaultserverconf="${jbossws.default.server.deploy.conf}"
                            modifyjbossintegration="true"/><!-- [JBWS-2505] -->
  </target>

  <!-- ================================================================== -->
  <!-- Prepare Deployment Structure JBoss-6.1.0                           -->
  <!-- ================================================================== -->

  <target name="deploy-structure-jboss610" depends="prepare-deploy">
    <delete dir="${deploy.structure}"/>
    <antcall target="deploy-jbossws-native" inheritall="false">
      <param name="installserver" value="${deploy.structure}/server/${jboss.server.instance}"/>
      <param name="jbossid" value="${jbossws.integration.target}"/>
      <param name="artifactsdir" value="${deploy.artifacts.dir}"/>
      <param name="thirdpartydir" value="${deploy.artifacts.dir}"/>
      <param name="modifyjbossintegration" value="true"/><!-- [JBWS-2505] -->
    </antcall>
    <macro-create-deploy-conf deploystructure="${deploy.structure}"/>
  </target>

  <!-- ================================================================== -->
  <!-- Deployment JBoss610                                                -->
  <!-- ================================================================== -->

  <target name="target-jboss610">
    <property name="jbossws.integration.target" value="jboss610"/>
    <echo message="jbossws.integration.target=${jbossws.integration.target}" file="${target.properties.file}"/>
  </target>

  <target name="deploy-jboss610" depends="undeploy-jboss610,deploy-structure-jboss610" description="Deploy jbossws to jboss610">
    <fail message="Not available: ${jboss610.available.file}" unless="jboss610.available"/>
    <copy todir="${jboss610.home}" overwrite="true" verbose="true">
      <fileset dir="${deploy.structure}"/>
    </copy>
    <chmod dir="${jboss610.home}/bin" perm="+x" includes="*.sh"/>
  </target>

  <target name="undeploy-jboss610" depends="target-jboss610,init" description="Remove jbossws from jboss610">
    <fail message="Not available: ${jboss610.available.file}" unless="jboss610.available"/>
    <macro-undeploy-jbossws targetdir="${jboss610.server}"
                            defaultconf="${jbossws.default.deploy.conf}"
                            defaultserverconf="${jbossws.default.server.deploy.conf}"
                            modifyjbossintegration="true"/><!-- [JBWS-2505] -->
  </target>

  <!-- ================================================================== -->
  <!-- Prepare Deployment Structure JBoss-7.0.x                           -->
  <!-- ================================================================== -->

  <target name="deploy-structure-jboss70x" depends="prepare-deploy">
    <delete dir="${deploy.structure}"/>

    <path id="jbossws-common-tools.path">
      <fileset dir="${deploy.artifacts.dir}">
        <include name="**/jbossws-common-tools.jar"/>
      </fileset>
    </path>
    <taskdef name="installModules" classname="org.jboss.ws.tools.ant.InstallModulesTask" classpathref="jbossws-common-tools.path"/>

    <antcall target="deploy-jbossws-native-modules" inheritall="false">
      <param name="installserver" value="${deploy.structure}"/>
      <param name="thirdpartydir" value="${deploy.artifacts.dir}"/>
      <param name="jbossid" value="${jbossws.integration.target}"/>
      <param name="modules-jbossid" value="jboss700"/>
    </antcall>
  </target>

  <!-- ================================================================== -->
  <!-- Deployment JBoss700                                                -->
  <!-- ================================================================== -->

  <target name="target-jboss700">
    <property name="jbossws.integration.target" value="jboss700"/>
    <echo message="jbossws.integration.target=${jbossws.integration.target}" file="${target.properties.file}"/>
  </target>

  <target name="deploy-jboss700" depends="undeploy-jboss700,deploy-structure-jboss70x" description="Deploy jbossws to jboss700">
    <fail message="Not available: ${jboss700.available.file}" unless="jboss700.available"/>
    <copy todir="${jboss700.home}" overwrite="true" verbose="true">
      <fileset dir="${deploy.structure}">
        <exclude name="**/jboss/as/webservices/**/module.xml"/>
      </fileset>
    </copy>
    <!-- Install org/jboss/as/webservices module.xml separately since it needs to reference libs already on the AS -->
    <installModules targetDir="${jboss700.home}/modules">
      <fileset dir="${deploy.structure}/modules">
        <include name="**/jboss/as/webservices/**/module.xml"/>
      </fileset>
    </installModules>
  </target>

  <target name="undeploy-jboss700" depends="target-jboss700,init" description="Remove jbossws from jboss700">
    <fail message="Not available: ${jboss700.available.file}" unless="jboss700.available"/>
    <macro-undeploy-jbossws-modules targetdir="${jboss700.home}" defaultmodulesconf="${jbossws.default.modules.conf}" modifyjbossintegration="true"/>
  </target>

   <!-- ================================================================== -->
   <!-- Deployment JBoss701                                                -->
   <!-- ================================================================== --> 

   <target name="target-jboss701">
     <property name="jbossws.integration.target" value="jboss701"/>
     <echo message="jbossws.integration.target=${jbossws.integration.target}" file="${target.properties.file}"/>
   </target>

   <target name="deploy-jboss701" depends="undeploy-jboss701,deploy-structure-jboss70x" description="Deploy jbossws to jboss701">
     <fail message="Not available: ${jboss701.available.file}" unless="jboss701.available"/>
     <copy todir="${jboss701.home}" overwrite="true" verbose="true">
       <fileset dir="${deploy.structure}">
         <exclude name="**/jboss/as/webservices/**/module.xml"/>
       </fileset>
     </copy>
     <!-- Install org/jboss/as/webservices module.xml separately since it needs to reference libs already on the AS -->
     <installModules targetDir="${jboss701.home}/modules">
       <fileset dir="${deploy.structure}/modules">
         <include name="**/jboss/as/webservices/**/module.xml"/>
       </fileset>
     </installModules>
   </target>

   <target name="undeploy-jboss701" depends="target-jboss701,init" description="Remove jbossws from jboss701">
     <fail message="Not available: ${jboss701.available.file}" unless="jboss701.available"/>
     <macro-undeploy-jbossws-modules targetdir="${jboss701.home}" defaultmodulesconf="${jbossws.default.modules.conf}" modifyjbossintegration="true"/>
   </target>

   <!-- ================================================================== -->
   <!-- Deployment JBoss702                                                -->
   <!-- ================================================================== -->

   <target name="target-jboss702">
     <property name="jbossws.integration.target" value="jboss702"/>
     <echo message="jbossws.integration.target=${jbossws.integration.target}" file="${target.properties.file}"/>
   </target>

   <target name="deploy-jboss702" depends="undeploy-jboss702,deploy-structure-jboss70x" description="Deploy jbossws to jboss702">
     <fail message="Not available: ${jboss702.available.file}" unless="jboss702.available"/>
     <copy todir="${jboss702.home}" overwrite="true" verbose="true">
       <fileset dir="${deploy.structure}">
         <exclude name="**/jboss/as/webservices/**/module.xml"/>
       </fileset>
     </copy>
     <!-- Install org/jboss/as/webservices module.xml separately since it needs to reference libs already on the AS -->
     <installModules targetDir="${jboss702.home}/modules">
       <fileset dir="${deploy.structure}/modules">
         <include name="**/jboss/as/webservices/**/module.xml"/>
       </fileset>
     </installModules>
   </target>

   <target name="undeploy-jboss702" depends="target-jboss702,init" description="Remove jbossws from jboss702">
     <fail message="Not available: ${jboss702.available.file}" unless="jboss702.available"/>
     <macro-undeploy-jbossws-modules targetdir="${jboss702.home}" defaultmodulesconf="${jbossws.default.modules.conf}" modifyjbossintegration="true"/>
   </target>

   <!-- ================================================================== -->
   <!-- Prepare Deployment Structure JBoss-7.1.0                           -->
   <!-- ================================================================== -->

   <target name="deploy-structure-jboss710" depends="prepare-deploy">
     <delete dir="${deploy.structure}"/>

     <path id="jbossws-common.path">
       <fileset dir="${deploy.artifacts.dir}">
         <include name="**/jbossws-common-tools.jar"/>
       </fileset>
     </path>
     <taskdef name="installModules" classname="org.jboss.ws.tools.ant.InstallModulesTask" classpathref="jbossws-common.path"/>

     <antcall target="deploy-jbossws-native-modules" inheritall="false">
       <param name="installserver" value="${deploy.structure}"/>
       <param name="thirdpartydir" value="${deploy.artifacts.dir}"/>
       <param name="jbossid" value="${jbossws.integration.target}"/>
       <param name="modules-jbossid" value="jboss710"/>
     </antcall>
   </target>

   <!-- ================================================================== -->
   <!-- Deployment jboss710                                                -->
   <!-- ================================================================== -->

   <target name="target-jboss710">
     <property name="jbossws.integration.target" value="jboss710"/>
     <echo message="jbossws.integration.target=${jbossws.integration.target}" file="${target.properties.file}"/>
   </target>

   <target name="deploy-jboss710" depends="undeploy-jboss710,deploy-structure-jboss710" description="Deploy jbossws to jboss710">
     <fail message="Not available: ${jboss710.available.file}" unless="jboss710.available"/>
     <copy todir="${jboss710.home}" overwrite="true" verbose="true">
       <fileset dir="${deploy.structure}">
         <exclude name="**/jboss/as/webservices/**/module.xml"/>
       </fileset>
     </copy>
     <!-- Install org/jboss/as/webservices module.xml separately since it needs to reference libs already on the AS -->
     <installModules targetDir="${jboss710.home}/modules">
       <fileset dir="${deploy.structure}/modules">
         <include name="**/jboss/as/webservices/**/module.xml"/>
       </fileset>
     </installModules>
   </target>

   <target name="undeploy-jboss710" depends="target-jboss710,init" description="Remove jbossws from jboss710">
     <fail message="Not available: ${jboss710.available.file}" unless="jboss710.available"/>
     <macro-undeploy-jbossws-modules targetdir="${jboss710.home}" defaultmodulesconf="${jbossws.default.modules.conf}"  modifyjbossintegration="false"/>
   </target>

  <!-- ================================================================== -->
  <!-- Create jbossws-deploy.conf and jbossws-server-deploy.conf          -->
  <!-- ================================================================== -->

  <patternset id="jbossws.deploy.conf.patternset">
    <exclude name="**/client/jbossws-native-core.jar"/>
    <exclude name="**/client/netty.jar"/>
    <exclude name="**/common/lib/jbossws-native-core.jar"/>
    <exclude name="**/common/lib/netty.jar"/>
    <exclude name="**/server/**"/>
  </patternset>

  <patternset id="jbossws.server.deploy.conf.patternset">
    <exclude name="**/juddi-service.sar/**"/>
  </patternset>

  <macrodef name="macro-create-deploy-conf">
    <attribute name="deploystructure"/>
    <sequential>
      <property name="jbossws.deployers.dir" value="@{deploystructure}/server/${jboss.server.instance}/deployers/jbossws.deployer"/>
      <!-- Create jbossws-deploy.conf -->
      <fileset id="jbossws.deploy.fileset" dir="@{deploystructure}">
      <patternset refid="jbossws.deploy.conf.patternset"/>
      </fileset>
      <property name="jbossws.deploy.fileset" refid="jbossws.deploy.fileset"/>
      <echo file="${jbossws.deployers.dir}/jbossws-deploy.conf" message="${jbossws.deploy.fileset}"/>
      <replace file="${jbossws.deployers.dir}/jbossws-deploy.conf" token=";" value=" "/>
      <!-- Create jbossws-server-deploy.conf -->
      <fileset id="jbossws.server.deploy.fileset" dir="@{deploystructure}/server/${jboss.server.instance}">
        <patternset refid="jbossws.server.deploy.conf.patternset"/>
      </fileset>
      <property name="jbossws.server.deploy.fileset" refid="jbossws.server.deploy.fileset"/>
      <echo file="${jbossws.deployers.dir}/jbossws-server-deploy.conf" message="${jbossws.server.deploy.fileset}"/>
      <replace file="${jbossws.deployers.dir}/jbossws-server-deploy.conf" token=";" value=" "/>
    </sequential>
  </macrodef>

</project>
