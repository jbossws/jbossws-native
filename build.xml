<?xml version="1.0" encoding="UTF-8"?>

<!-- ====================================================================== -->
<!--                                                                        -->
<!--  JBoss, the OpenSource J2EE webOS                                      -->
<!--                                                                        -->
<!--  Distributable under LGPL license.                                     -->
<!--  See terms of license at http://www.gnu.org.                           -->
<!--                                                                        -->
<!-- ====================================================================== -->

<!-- $Id$ -->

<project basedir="." name="JBossWS-Native">
  
  <!-- ================================================================== -->
  <!-- Setup                                                              -->
  <!-- ================================================================== -->

  <property name="stack.dir" value="${basedir}"/>
  <property name="stack.distro.dir" value="${stack.dir}/src/main/distro"/>
  <property name="stack.output.dir" value="${stack.dir}/target"/>
  
  <property name="deploy.artifacts.dir" value="${stack.output.dir}/deploy-artifacts"/>
  
  <import file="${stack.distro.dir}/build-setup.xml"/>
  <import file="${stack.distro.dir}/build-deploy.xml"/>
  <import file="${stack.distro.dir}/jbossws-deploy-macros.xml"/>
  
  <property name="jbossws.default.deploy.conf" value="${stack.distro.dir}/jbossws-default-deploy.conf"/>
  <property name="target.properties.file" value="${basedir}/target.properties"/>
  
  <!-- ================================================================== -->
  <!-- Initialization                                                     -->
  <!-- ================================================================== -->

  <!--
    Loads the jboss.home properties from the effective maven settings
  -->  
  <target name="mvn-settings">
    <mkdir dir="${stack.output.dir}"/>
    <exec dir="${basedir}" executable="mvn" failonerror="true" output="${stack.output.dir}/effective-settings.txt">
      <arg value="help:effective-settings"/>
    </exec>
    <loadfile srcfile="${stack.output.dir}/effective-settings.txt" property="mvn.effective.settings">
      <filterchain>
        <tokenfilter>
          <replaceregex pattern="\[INFO\](.*)" replace=""/>
          <replaceregex pattern="Effective settings:" replace=""/>
          <replaceregex pattern=".\?xml(.*)\?\>" replace=""/>
        </tokenfilter>
      </filterchain>
    </loadfile>
    <echo message="${mvn.effective.settings}" file="${stack.output.dir}/effective-settings.xml"/>
    <xmlproperty file="${stack.output.dir}/effective-settings.xml"/>
    <property name="jboss421.home" value="${settings.profiles.profile.properties.jboss421.home}"/>
    <property name="jboss422.home" value="${settings.profiles.profile.properties.jboss422.home}"/>
    <property name="jboss423.home" value="${settings.profiles.profile.properties.jboss423.home}"/>
    <property name="jboss500.home" value="${settings.profiles.profile.properties.jboss500.home}"/>
    <property name="jboss501.home" value="${settings.profiles.profile.properties.jboss501.home}"/>
    <echo message="jboss421.home=${jboss421.home}"/>
    <echo message="jboss422.home=${jboss422.home}"/>
    <echo message="jboss423.home=${jboss423.home}"/>
    <echo message="jboss500.home=${jboss500.home}"/>
    <echo message="jboss501.home=${jboss501.home}"/>
  </target>
  
  <target name="init" depends="mvn-settings,prepare">
    
    <xmlproperty file="${stack.dir}/pom.xml"/>
    <property name="version.id" value="${project.version}"/>
          
    <echo message="version.id=${version.id}"/>
    <echo message="integration.target=${jbossws.integration.target}"/>
    
    <fail message="jbossws.integration.target not set" unless="jbossws.integration.target"/>
    <property name="deploy.structure" value="${stack.output.dir}/deploy-${jbossws.integration.target}"/>
  </target>
  
  <!-- ================================================================== -->
  <!-- Distribution                                                       -->
  <!-- ================================================================== -->
  
  <target name="prepare-deploy" depends="prepare">
    
    <echo message="**********************************"/>
    <echo message="* mvn package assembly:directory *"/>
    <echo message="**********************************"/>
    
    <delete dir="${deploy.artifacts.dir}"/>
    <exec dir="${basedir}" executable="mvn" failonerror="true">
      <arg value="package"/>
      <arg value="assembly:directory"/>
    </exec>
  </target>
  
  <target name="build-bin-dist" depends="prepare-deploy" description="Build the binary distribution">
    
    <echo message="********************************************"/>
    <echo message="* mvn -Pbindist package assembly:directory *"/>
    <echo message="********************************************"/>
    
    <delete dir="${stack.output.dir}/jbossws-native-dist"/>
    <exec dir="${basedir}" executable="mvn" failonerror="true">
      <arg value="-Pbindist"/>
      <arg value="package"/>
      <arg value="assembly:directory"/>
    </exec>
  </target>
  
  <!-- ================================================================== -->
  <!-- Miscellaneous                                                       -->
  <!-- ================================================================== -->
  
  <target name="clean" depends="prepare" description="Cleans up most generated files.">
    
    <echo message="*************************************"/>
    <echo message="* mvn clean                         *"/>
    <echo message="*************************************"/>
    
    <exec dir="${basedir}" executable="mvn" failonerror="true">
      <arg value="clean"/>
    </exec>
  </target>
  
</project>
