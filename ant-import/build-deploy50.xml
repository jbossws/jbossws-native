<?xml version="1.0" encoding="UTF-8"?>

<!-- ====================================================================== -->
<!--                                                                        -->
<!--  JBoss, the OpenSource J2EE webOS                                      -->
<!--                                                                        -->
<!--  Distributable under LGPL license.                                     -->
<!--  See terms of license at http://www.gnu.org.                           -->
<!--                                                                        -->
<!-- ====================================================================== -->

<!-- $Id$ -->

<project>
  
  <import file="${core.dir}/ant-import/jbossws-deploy-macros.xml"/>
  
	<property name="jbossws.default.undeploy.files" value="${core.dir}/ant-import/jbossws-default-deploy.conf"/>
  
  <!-- ================================================================== -->
  <!-- Deployment JBoss500                                                -->
  <!-- ================================================================== -->

  <target name="deploy-jboss500" depends="undeploy-jboss500,prepare-deploy50" description="Deploy jbossws to jboss500">
    <fail message="Not available: ${jboss500.available.file}" unless="jboss500.available"/>
    <copy todir="${jboss500.home}" overwrite="true">
      <fileset dir="${core.output.deploy.dir}" excludes="jbossws-deploy.conf"/>
    </copy>
    <chmod dir="${jboss500.home}/bin" perm="+x" includes="*.sh"/>
  </target>
  
  <target name="undeploy-jboss500" depends="prepare" description="Remove jbossws from jboss500">
    <fail message="Not available: ${jboss500.available.file}" unless="jboss500.available"/>
    <macro-undeploy-jbossws targetdir="${jboss500.server.deploy}/jbossws.sar"/>
  </target>
  
  <!-- ================================================================== -->
  <!-- Deployment JBoss501                                                -->
  <!-- ================================================================== -->

  <target name="deploy-jboss501" depends="undeploy-jboss501,prepare-deploy50" description="Deploy jbossws to jboss501">
    <fail message="Not available: ${jboss501.available.file}" unless="jboss501.available"/>
    <copy todir="${jboss501.home}" overwrite="true">
      <fileset dir="${core.output.deploy.dir}" excludes="jbossws-deploy.conf"/>
    </copy>
    <chmod dir="${jboss501.home}/bin" perm="+x" includes="*.sh"/>
  </target>
  
  <target name="undeploy-jboss501" depends="prepare" description="Remove jbossws from jboss501">
    <fail message="Not available: ${jboss501.available.file}" unless="jboss501.available"/>
    <macro-undeploy-jbossws targetdir="${jboss501.server.deploy}/jbossws.sar"/>
  </target>
  
  <!-- ================================================================== -->
  <!-- Prepare Deployment JBoss-5.0.x                                     -->
  <!-- ================================================================== -->

  <target name="prepare-deploy50" depends="jars">
    
    <delete dir="${core.output.deploy.dir}-src"/>
    <delete dir="${core.output.deploy.dir}"/>
    
    <!-- Copy all artifacts to a flat deploy src -->
    <unzip dest="${core.output.deploy.dir}-src/bin" src="${thirdparty.dir}/jbossws-framework-scripts.zip"/>
    <unzip dest="${core.output.deploy.dir}-src/bin" src="${core.output.lib.dir}/jbossws-core-scripts.zip"/>
    <copy todir="${core.output.deploy.dir}-src/lib">
      <fileset dir="${thirdparty.dir}">
        <patternset refid="jbossws.client.patternset"/>
        <patternset refid="jbossws.lib.patternset"/>
        <patternset refid="jbossws.lib.endorsed.patternset"/>
        <patternset refid="jbossws.server.lib.patternset"/>
        <patternset refid="jbossws.service.lib.patternset"/>
      </fileset>
      <fileset dir="${core.output.lib.dir}">
        <patternset refid="jbossws.client.patternset"/>
        <patternset refid="jbossws.lib.patternset"/>
        <patternset refid="jbossws.lib.endorsed.patternset"/>
        <patternset refid="jbossws.server.lib.patternset"/>
        <patternset refid="jbossws.service.lib.patternset"/>
        <include name="jbossws-context.war"/>
      </fileset>
    </copy>
    <copy todir="${core.output.deploy.dir}-src/resources">
      <fileset dir="${core.output.resources.dir}">
        <include name="standard-*-config.xml"/>
        <include name="jbossws-native50-beans.xml"/>
      </fileset>
    </copy>
    
    <!-- Create the deployment structure -->
    <antcall target="deploy-jbossws-native50" inheritall="false">
      <param name="installserver" value="${core.output.deploy.dir}/server/${jboss.server.instance}"/>
      <param name="thirdpartydir" value="${core.output.deploy.dir}-src"/>
    </antcall>
    
    <!-- Create jbossws-deploy.conf -->
    <fileset id="jbossws.deploy.fileset" dir="${core.output.deploy.dir}" excludes="**/jbossws-deploy.conf,**/jbossws.sar/**"/>
    <property name="jbossws.deploy.fileset" refid="jbossws.deploy.fileset"/>
    <property name="jbossws.sar.dir" value="${core.output.deploy.dir}/server/${jboss.server.instance}/deploy/jbossws.sar"/>
    <echo file="${jbossws.sar.dir}/jbossws-deploy.conf" message="${jbossws.deploy.fileset} server/${jboss.server.instance}/deploy/jbossws.sar"/>
    <replace file="${jbossws.sar.dir}/jbossws-deploy.conf" token=";" value=" "/>
  </target>
  
</project>
